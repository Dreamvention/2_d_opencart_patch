<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>d_opencart_patch</name>
    <code>d_opencart_patch</code>
    <description>Ports the new module extension folder structure to old Opencarts 2.x</description>
    <version>2.x</version>
    <author>Dreamvention</author>
    <link>http://dreamvention.com</link>

    <!-- SYSTEM -->
    <file path="system/engine/loader.php">
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[public function controller($route, $args = array()) {]]></search>
            <add position="after"><![CDATA[
        //d_opencart_patch.xml 1
        if(strpos($route, 'module/') === 0){
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'total/') === 0){
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'analytics/') === 0){
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'fraud/') === 0){
            preg_match("/(\/)/", $route, $match);
            $test_route = (count($match) > 1) ? preg_replace("/(\/)[a-z0-9_\-]+$/", "", $route) : $route;
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $test_route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'payment/') === 0){
            preg_match("/(\/)/", $route, $match);
            $test_route = (count($match) > 1) ? preg_replace("/(\/)[a-z0-9_\-]+$/", "", $route) : $route;
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $test_route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'captcha/') === 0){
            preg_match("/(\/)/", $route, $match);
            $test_route = (count($match) > 1) ? preg_replace("/(\/)[a-z0-9_\-]+$/", "", $route) : $route;
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $test_route . '.php')){
                $route = 'extension/'.$route;
            }
        }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$controller = new $class($this->registry);]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 2
        if(!is_file($file)){
            return false;
        }
            ]]></add>
        </operation>
    </file>

    <file path="system/engine/loader.php">
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[public function controller($route, $data = array()) {]]></search>
            <add position="after"><![CDATA[
        //d_opencart_patch.xml 1
        if(strpos($route, 'module/') === 0){
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'total/') === 0){
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'analytics/') === 0){
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'fraud/') === 0){
            preg_match("/(\/)/", $route, $match);
            $test_route = (count($match) > 1) ? preg_replace("/(\/)[a-z0-9_\-]+$/", "", $route) : $route;
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $test_route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'payment/') === 0){
            preg_match("/(\/)/", $route, $match);
            $test_route = (count($match) > 1) ? preg_replace("/(\/)[a-z0-9_\-]+$/", "", $route) : $route;
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $test_route . '.php')){
                $route = 'extension/'.$route;
            }
        }
        if(strpos($route, 'captcha/') === 0){
            preg_match("/(\/)/", $route, $match);
            $test_route = (count($match) > 1) ? preg_replace("/(\/)[a-z0-9_\-]+$/", "", $route) : $route;
            if(file_exists(DIR_APPLICATION . 'controller/extension/' . $test_route . '.php')){
                $route = 'extension/'.$route;
            }
        }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$controller = new $class($this->registry);]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 2
        if(!is_file($file)){
            return false;
        }
            ]]></add>
        </operation>
    </file>

    <file path="system/library/language.php">
        <operation error="skip" info="port new module structure to old oc2">
                <search><![CDATA[$file = DIR_LANGUAGE . $this->default . '/' . $filename . '.php';]]></search>
                <add position="before"><![CDATA[
            //d_opencart_patch.xml
            $file = DIR_LANGUAGE . 'en-gb/' . $filename . '.php';
            if (is_file($file)) {
                require($file);
            }
                ]]></add>
            </operation>
    </file>

    <file path="system/engine/action.php">
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$parts = explode('/', str_replace('../', '', (string)$route));]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml action
        $parts = explode('/', preg_replace('/[^a-zA-Z0-9_\/]/', '', (string)$route));
        $this->method = 'index';
        while ($parts) {
            $path = implode('/', $parts);
            $file = DIR_APPLICATION . 'controller/' . $path . '.php';
            if (is_file($file)) {
                $this->file = $file;
                $this->class = 'Controller' . preg_replace('/[^a-zA-Z0-9]/', '', $path);
                break;
            } else {
                $this->method = array_pop($parts);
            }
        }
        if ($args) {
            $this->args = $args;
        }
        return;
        //the following code will be ignored.
            ]]></add>
        </operation>
    </file>

    <!-- ADMIN -->
    <file path="admin/controller/extension/module.php">
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->load->controller('module/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/module/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/module/' . $this->request->get['extension']);
            $this->load->controller('extension/module/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->load->controller('module/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/module/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/module/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/module/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/module/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->load->language('module/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/module/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/module/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/module/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/module/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/module/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/module/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/module/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/shipping.php">
        <operation error="skip" info="port new shipping structure to old oc2">
            <search><![CDATA[$this->load->controller('shipping/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/shipping/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/shipping/' . $this->request->get['extension']);
            $this->load->controller('extension/shipping/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new shipping structure to old oc2">
            <search><![CDATA[$this->load->controller('shipping/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/shipping/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new shipping structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/shipping/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/shipping/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/shipping/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new shipping structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new shipping structure to old oc2">
            <search><![CDATA[$this->load->language('shipping/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/shipping/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/shipping/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/shipping/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/shipping/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'sort_order' => $this->config->get($extension . '_sort_order'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/shipping/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/shipping/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/shipping/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/payment.php">
        <operation error="skip" info="port new payment structure to old oc2">
            <search><![CDATA[$this->load->controller('payment/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/payment/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/payment/' . $this->request->get['extension']);
            $this->load->controller('extension/payment/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new payment structure to old oc2">
            <search><![CDATA[$this->load->controller('payment/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/payment/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new payment structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/payment/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/payment/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/payment/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new payment structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new payment structure to old oc2">
            <search><![CDATA[$this->load->language('payment/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/payment/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/payment/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/payment/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/payment/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'sort_order' => $this->config->get($extension . '_sort_order'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/payment/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/payment/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/payment/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/dashboard.php">
        <operation error="skip" info="port new dashboard structure to old oc2">
            <search><![CDATA[$this->load->controller('dashboard/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/dashboard/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/dashboard/' . $this->request->get['extension']);
            $this->load->controller('extension/dashboard/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new dashboard structure to old oc2">
            <search><![CDATA[$this->load->controller('dashboard/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/dashboard/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new dashboard structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/dashboard/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/dashboard/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/dashboard/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new dashboard structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new dashboard structure to old oc2">
            <search><![CDATA[$this->load->language('dashboard/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/dashboard/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/dashboard/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/dashboard/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/dashboard/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/dashboard/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/dashboard/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/dashboard/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/total.php">
        <operation error="skip" info="port new total structure to old oc2">
            <search><![CDATA[$this->load->controller('total/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/total/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/total/' . $this->request->get['extension']);
            $this->load->controller('extension/total/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new total structure to old oc2">
            <search><![CDATA[$this->load->controller('total/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/total/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new total structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/total/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/total/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/total/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new total structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new total structure to old oc2">
            <search><![CDATA[$this->load->language('total/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/total/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/total/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/total/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/total/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'sort_order' => $this->config->get($extension . '_sort_order'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/total/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/total/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/total/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/feed.php">
        <operation error="skip" info="port new feed structure to old oc2">
            <search><![CDATA[$this->load->controller('feed/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/feed/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/feed/' . $this->request->get['extension']);
            $this->load->controller('extension/feed/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new feed structure to old oc2">
            <search><![CDATA[$this->load->controller('feed/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/feed/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new feed structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/feed/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/feed/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/feed/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new feed structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new feed structure to old oc2">
            <search><![CDATA[$this->load->language('feed/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/feed/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/feed/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/feed/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/feed/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/feed/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/feed/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/feed/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/fraud.php">
        <operation error="skip" info="port new fraud structure to old oc2">
            <search><![CDATA[$this->load->controller('fraud/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/fraud/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/fraud/' . $this->request->get['extension']);
            $this->load->controller('extension/fraud/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new fraud structure to old oc2">
            <search><![CDATA[$this->load->controller('fraud/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/fraud/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new fraud structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/fraud/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/fraud/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/fraud/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new fraud structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new fraud structure to old oc2">
            <search><![CDATA[$this->load->language('fraud/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/fraud/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/fraud/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/fraud/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/fraud/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/fraud/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/fraud/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/fraud/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/analytics.php">
        <operation error="skip" info="port new analytics structure to old oc2">
            <search><![CDATA[$this->load->controller('analytics/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/analytics/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/analytics/' . $this->request->get['extension']);
            $this->load->controller('extension/analytics/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new analytics structure to old oc2">
            <search><![CDATA[$this->load->controller('analytics/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/analytics/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new analytics structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/analytics/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/analytics/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/analytics/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new analytics structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new analytics structure to old oc2">
            <search><![CDATA[$this->load->language('analytics/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/analytics/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/analytics/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/analytics/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/analytics/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/analytics/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/analytics/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/analytics/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>

    <file path="admin/controller/extension/captcha.php">
        <operation error="skip" info="port new captcha structure to old oc2">
            <search><![CDATA[$this->load->controller('captcha/' . $this->request->get['extension'] . '/install');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            $this->load->model('extension/d_opencart_patch/user');
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'access', 'extension/captcha/' . $this->request->get['extension']);
            $this->model_user_user_group->addPermission($this->model_extension_d_opencart_patch_user->getGroupId(), 'modify', 'extension/captcha/' . $this->request->get['extension']);
            $this->load->controller('extension/captcha/' . $this->request->get['extension'] . '/install');
            ]]></add>
        </operation>
        <operation error="skip" info="port new captcha structure to old oc2">
            <search><![CDATA[$this->load->controller('captcha/' . $this->request->get['extension'] . '/uninstall');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $this->load->controller('extension/captcha/' . $this->request->get['extension'] . '/uninstall');
            ]]></add>
        </operation>
        <operation error="skip" info="port new captcha structure to old oc2">
            <search><![CDATA[if (!file_exists(DIR_APPLICATION . 'controller/captcha/' . $value . '.php')) {]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 3
                if (!file_exists(DIR_APPLICATION . 'controller/captcha/' . $value . '.php')
                && !file_exists(DIR_APPLICATION . 'controller/extension/captcha/' . $value . '.php')) {
            ]]></add>
        </operation>
        <operation error="skip" info="port new captcha structure to old oc2">
            <search><![CDATA[$data['extensions'][] = array(]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 4
                $data['extensions'][$extension] = array(
            ]]></add>
        </operation>
        <operation error="skip" info="port new captcha structure to old oc2">
            <search><![CDATA[$this->load->language('captcha/' . $extension);]]></search>
            <add position="before"><![CDATA[
                //d_opencart_patch.xml 5
                if($extension == 'd_opencart_patch'){
                    continue;
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$data['header'] = $this->load->controller('common/header');]]></search>
            <add position="before"><![CDATA[
        //d_opencart_patch.xml 6
        $files = glob(DIR_APPLICATION . 'controller/extension/captcha/*.php');
        if ($files) {
            foreach ($files as $file) {
                $extension = basename($file, '.php');
                if($extension == 'd_opencart_patch'){
                    continue;
                }
                $this->load->language('extension/captcha/' . $extension);
                $module_data = array();
                if(VERSION > "2.0.0.0"){
                    $this->load->model('extension/module');
                    $modules = $this->model_extension_module->getModulesByCode($extension);
                    foreach ($modules as $module) {
                        $module_data[] = array(
                            'module_id' => $module['module_id'],
                            'name'      => $this->language->get('heading_title') . ' &gt; ' . $module['name'],
                            'edit'      => $this->url->link('extension/captcha/' . $extension, 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL'),
                            'delete'    => $this->url->link('extension/captcha/delete', 'token=' . $this->session->data['token'] . '&module_id=' . $module['module_id'], 'SSL')
                        );
                    }
                }
                $data['extensions'][$extension] = array(
                    'name'      => $this->language->get('heading_title'),
                    'status'    => $this->config->get($extension . '_status') ? $this->language->get('text_enabled') : $this->language->get('text_disabled'),
                    'module'    => $module_data,
                    'install'   => $this->url->link('extension/captcha/install', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'uninstall' => $this->url->link('extension/captcha/uninstall', 'token=' . $this->session->data['token'] . '&extension=' . $extension, 'SSL'),
                    'installed' => in_array($extension, $extensions),
                    'edit'      => $this->url->link('extension/captcha/' . $extension, 'token=' . $this->session->data['token'], 'SSL')
                );
            }
        }
        $sort_order = array();
        foreach ($data['extensions'] as $key => $value) {
            $sort_order[$key] = $value['name'];
        }
        array_multisort($sort_order, SORT_ASC, $data['extensions']);
            ]]></add>
        </operation>
    </file>


    <file path="admin/controller/startup/permission.php,admin/controller/error/permission.php">
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$ignore = array(]]></search>
            <add position="after"><![CDATA[
        //d_opencart_patch.xml 1
        'extension/dashboard',
            ]]></add>
        </operation>
    </file>

    <!-- CATALLOG -->
    <file path="catalog/controller/checkout/shipping_method.php">
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$quote = $this->{'model_shipping_' . $result['code']}->getQuote($this->session->data['shipping_address']);]]></search>
            <add position="replace"><![CDATA[////]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->load->model('shipping/' . $result['code']);]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 1
                if(file_exists(DIR_APPLICATION . 'model/extension/shipping/' . $result['code'] . '.php')){
                    $this->load->model('extension/shipping/' . $result['code']);
                    $quote = $this->{'model_extension_shipping_' . $result['code']}->getQuote($this->session->data['shipping_address']);
                } elseif (file_exists(DIR_APPLICATION . 'model/shipping/' . $result['code'] . '.php')) {
                    $this->load->model('shipping/' . $result['code']);
                    $quote = $this->{'model_shipping_' . $result['code']}->getQuote($this->session->data['shipping_address']);
                }
            ]]></add>
        </operation>
    </file>

    <file path="catalog/controller/checkout/payment_method.php">
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->{'model_total_' . $result['code']}->getTotal($total_data, $total, $taxes);]]></search>
            <add position="replace"><![CDATA[////]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->load->model('total/' . $result['code']);]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 1
                if(file_exists(DIR_APPLICATION . 'model/extension/total/' . $result['code'] . '.php')){
                    $this->load->model('extension/total/' . $result['code']);
                    $this->{'model_extension_total_' . $result['code']}->getTotal($total_data, $total, $taxes);
                } elseif (file_exists(DIR_APPLICATION . 'model/total/' . $result['code'] . '.php')) {
                    $this->load->model('total/' . $result['code']);
                    $this->{'model_total_' . $result['code']}->getTotal($total_data, $total, $taxes);
                }
            ]]></add>
        </operation>
         <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->{'model_total_' . $result['code']}->getTotal($total_data);]]></search>
            <add position="replace"><![CDATA[
                //$this->{'model_total_' . $result['code']}->getTotal($total_data);
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$method = $this->{'model_payment_' . $result['code']}->getMethod($this->session->data['payment_address'], $total);]]></search>
            <add position="replace"><![CDATA[////]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[$this->load->model('payment/' . $result['code']);]]></search>
            <add position="replace"><![CDATA[
                //d_opencart_patch.xml 2
                if(file_exists(DIR_APPLICATION . 'model/extension/payment/' . $result['code'] . '.php')){
                    $this->load->model('extension/payment/' . $result['code']);
                    $method = $this->{'model_extension_payment_' . $result['code']}->getMethod($this->session->data['payment_address'], $total);
                } elseif (file_exists(DIR_APPLICATION . 'model/payment/' . $result['code'] . '.php')) {
                    $this->load->model('payment/' . $result['code']);
                    $method = $this->{'model_payment_' . $result['code']}->getMethod($this->session->data['payment_address'], $total);
                }
            ]]></add>
        </operation>
        <operation error="skip" info="port new module structure to old oc2">
            <search><![CDATA[if ($recurring) {]]></search>
            <add position="replace" offset="3"><![CDATA[
                //d_opencart_patch.xml 3
                if ($recurring) {
                    if(file_exists(DIR_APPLICATION . 'model/extension/payment/' . $result['code'] . '.php')){
                        if (property_exists($this->{'model_extension_payment_' . $result['code']}, 'recurringPayments') && $this->{'model_extension_payment_' . $result['code']}->recurringPayments()) {
                            $method_data[$result['code']] = $method;
                        }
                    } elseif (file_exists(DIR_APPLICATION . 'model/payment/' . $result['code'] . '.php')) {
                        if (method_exists($this->{'model_payment_' . $result['code']}, 'recurringPayments') && $this->{'model_payment_' . $result['code']}->recurringPayments()) {
                            $method_data[$result['code']] = $method;
                        }
                    }
            ]]></add>
        </operation>
    </file>
    <file path="admin/controller/design/layout.php">
        <operation error="skip">
            <search><![CDATA[$this->load->language('module/' . $code);]]></search>
            <add position="after"><![CDATA[
                //d_opencart_patch.xml
            if(file_exists(DIR_LANGUAGE . 'en-gb/extension/module/' . $code .'.php')){
                $this->load->language('extension/module/' . $code);
            }
            ]]></add>
        </operation>
    </file>
    <file path="admin/controller/user/user_permission.php">
        <operation error="skip">
            <search><![CDATA[$files = glob(DIR_APPLICATION . 'controller/*/*.php');]]></search>
            <add position="after"><![CDATA[
        //d_opencart_patch.xml 1
        $data['permissions'] = array();

        $files = array();

        // Make path into an array
        $path = array(DIR_APPLICATION . 'controller/*');

        // While the path array is still populated keep looping through
        while (count($path) != 0) {
            $next = array_shift($path);

            foreach (glob($next) as $file) {
                // If directory add to path array
                if (is_dir($file)) {
                    $files[] = $file;
                    $path[] = $file . '/*';
                }
                // Add the file to the files to be deleted array
                if (is_file($file)) {
                    $files[] = $file;
                }
            }
        }

        // Sort the file array
        sort($files);
            ]]></add>
        </operation>
    </file>
    <file path="admin/controller/user/user_permission.php">
        <operation error="skip">
            <search><![CDATA[$permission = end($part) . '/' . basename($file, '.php');]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 2
            $controller = substr($file, strlen(DIR_APPLICATION . 'controller/'));

            $permission = (strrpos($controller, '.') !== false) ? substr($controller, 0, strrpos($controller, '.')) : $controller;
            ]]></add>
        </operation>
    </file>
    <file path="admin/controller/extension/installer.php">
        <operation error="skip">
            <search><![CDATA[$modification_info = $this->model_extension_modification->getModificationByCode($code);]]></search>
            <add position="after"><![CDATA[
            //d_opencart_patch.xml 1
            if (strpos($code, 'd_') === 0 && $modification_info) {
                $this->model_extension_modification->deleteModification($modification_info['modification_id']);
                $modification_info = false; 
            }
            ]]></add>
        </operation>
    </file>

</modification>